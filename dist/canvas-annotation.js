!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).Canvas=e()}(this,(function(){"use strict";class t{constructor(){this.events={}}on(t,e){let i=this.events[t];Array.isArray(i)?i.push(e):this.events[t]=[e]}emit(t,...e){let i=this.events[t];i&&i.length&&i.forEach((t=>{t.call(null,...e)}))}off(t,e){let i=this.events[t],s=i.findIndex((t=>t===e));i.splice(s,1)}}class e extends t{constructor(t,{points:e,lineColor:i,fillColor:s,lineWidth:h,control:a,opacity:o,uuid:n}){super(),this.ctx=t,this.index=-1,this.opacity=o||.2,this.editIndex=-1,this.points=e||[],this.control=a||!0,this.controlPoints=[],this.lineColor=i||"#f00",this.fillColor=s||"#f00",this.lineWidth=h||3,this.creating=!1,this.editing=!1,this.activating=!1,this.uuid=n||Math.random(),this.canDrag=!0}controlPointsIndex(t){let e=this.getControlPoints(),{x:i,y:s}=t,h=this.ctx.canvas,a=this.ctx.getTransform();for(let t=0;t<e.length;t++){let{x:o,y:n}=e[t];if(i<o+5/a.a&&i>o-5/a.a&&s<n+5/a.a&&s>n-5/a.a)return h.style.cursor="pointer",t;h.style.cursor="auto"}return-1}drawControls(){let t=this.ctx.getTransform();this.ctx.save(),this.ctx.setTransform(1,0,0,1,0,0),this.getControlPoints().forEach((e=>{this.ctx.beginPath(),this.ctx.strokeStyle=this.lineColor,this.ctx.fillStyle="#fff",this.ctx.arc(e.x*t.a+t.e,e.y*t.a+t.f,5,0,2*Math.PI),this.ctx.stroke(),this.ctx.fill(),this.ctx.closePath()})),this.ctx.restore()}drawText(){if(!this.points.length)return;let t=this.ctx,e=t.getTransform(),i=t.measureText(this.type),{x:s,y:h}=this.points[0];s=s*e.a+e.e+10,h=h*e.a+e.f,t.save(),t.setTransform(1,0,0,1,0,0),this.ctx.font="14px 微软雅黑",t.beginPath(),t.save(),t.fillStyle=this.lineColor,t.fillRect(s+10,h,i.width+2*i.actualBoundingBoxAscent,20),t.restore(),t.fillStyle="#fff",t.fillText(this.type,s+10,h+14),t.closePath(),t.restore()}getData(){return{coordinates:this.points,type:this.type,uuid:this.uuid}}}let i={a:1,b:0,c:0,d:1,e:0,f:0,transform(t,e,i,s,h,a){let o=this;var n=o.a,r=o.b,l=o.c,c=o.d,x=o.e,p=o.f;return o.a=n*t+l*e,o.b=r*t+c*e,o.c=n*i+l*s,o.d=r*i+c*s,o.e=n*h+l*a+x,o.f=r*h+c*a+p,o},translate(t,e){return this.transform(1,0,0,1,t,e)},scaleU(t){return this.transform(t,0,0,t,0,0)},rotate(t){let e=this,i=Math.cos(t),s=Math.sin(t),h=-Math.sin(t),a=Math.cos(t),o=e.a,n=e.b,r=e.c,l=e.d,c=e.e,x=e.f;return e.a=o*i+r*s,e.b=n*i+l*s,e.c=o*h+r*a,e.d=n*h+l*a,e.e=0*o+0*r+c,e.f=0*n+0*l+x,this.transform(i,s,h,a,0,0)},getRotatePoint:(t,e)=>({x:e.x*Math.cos(t)+e.y*-Math.sin(t),y:e.y*Math.sin(t)+e.y*Math.cos(t)}),clone(){let{a:t,b:e,c:i,d:s,e:h,f:a}=this;return{a:t,b:e,c:i,d:s,e:h,f:a}},reset(){this.a=1,this.b=0,this.c=0,this.d=1,this.e=0,this.f=0}};class s extends e{startPos={x:null,y:null};constructor(t,e){super(t,e),this.type="rect",this.angle=0}initPoints(t,e){this.points[0]={x:t.x>e.x?e.x:t.x,y:t.y>e.y?e.y:t.y},this.points[1]={x:e.x>t.x?e.x:t.x,y:t.y>e.y?e.y:t.y},this.points[2]={x:e.x>t.x?e.x:t.x,y:e.y>t.y?e.y:t.y},this.points[3]={x:t.x>e.x?e.x:t.x,y:e.y>t.y?e.y:t.y}}getControlPoints(){let[t,e,i,s]=this.points;this.control_points=[t,{x:(t.x+e.x)/2,y:t.y},e,{x:e.x,y:(i.y+t.y)/2},i,{x:(t.x+e.x)/2,y:i.y},s,{x:t.x,y:(t.y+i.y)/2},{x:(t.x+e.x)/2,y:t.y-20}];let h=this.getShapeCenter();return this.getRotatePoints(h,this.angle)}drawGraph(){this.points.length<3&&this.initPoints(this.points[0],this.points[1]);let t=this.ctx.getTransform(),e=this.getShapeCenter();this.ctx.save(),this.ctx.setTransform(1,0,0,1,e.x*t.a+t.e,e.y*t.a+t.f),this.ctx.rotate(this.angle);let{x:i,y:s}=this.points[0],{x:h,y:a}=this.points[2];i=i*t.a+t.e,s=s*t.a+t.f,h=h*t.a+t.e,a=a*t.a+t.f,this.ctx.rect(-(h-i)/2,-(a-s)/2,h-i,a-s),this.ctx.closePath(),this.ctx.stroke(),this.ctx.restore(),this.activating&&this.drawControls()}drawControls(){let t=this.ctx.getTransform();this.getShapeCenter();let e=this.controlPoints=this.getControlPoints(),i=this.ctx;i.save(),i.setTransform(1,0,0,1,0,0),e.forEach(((s,h)=>{s.x=s.x*t.a+t.e,s.y=s.y*t.a+t.f,i.beginPath(),1===h&&(i.beginPath(),i.moveTo(s.x,s.y),i.lineTo(e[8].x*t.a+t.e,e[8].y*t.a+t.f),i.stroke(),i.closePath()),i.arc(s.x,s.y,5,0,2*Math.PI),i.stroke(),i.closePath()})),i.restore()}getArea(){let{x:t,y:e}=this.points[0],{x:i,y:s}=this.points[1];return(i-t)*(s-e)}getMaxAndMinmun(){return{max:this.points[2],min:this.points[0]}}getShapeCenter(){let{max:t,min:e}=this.getMaxAndMinmun();return this.width=t.x-e.x,this.height=t.y-e.y,{x:(t.x+e.x)/2,y:(t.y+e.y)/2}}updateGraph(t,e,i){let{x:s,y:h}=e;switch("object"!=typeof i||this.startPos.x||(this.startPos=i),t){case 0:this.controlPoints[0]=e,this.points[1].y=h,this.points[3].x=s;break;case 1:this.points[0].y=this.points[1].y=h;break;case 2:this.points[0].y=h,this.points[2].x=s,this.points[1]=e;break;case 8:let t=this.getShapeCenter(),i=Math.atan2(this.startPos.y-t.y,this.startPos.x-t.x),a=Math.atan2(e.y-t.y,e.x-t.x);this.angle+=a-i,this.startPos=e}}getAngle(t,e,i){const s=e.x-t.x,h=t.y-e.y,a=i.x-t.x,o=t.y-i.y,n=Math.sqrt(s*s+h*h)*Math.sqrt(a*a+o*o);if(0===n)return-1;const r=Math.acos((s*a+h*o)/n);return t.x-i.x<0&&t.y-i.y<0||t.x-i.x<0&&t.y-i.y>0?r:t.x-i.x>0&&t.y-i.y<0||t.x-i.x>0&&t.y-i.y>0?2*Math.PI-r:null}getRotatePoints({x:t,y:e},s){return this.control_points.map((t=>i.getRotatePoint(s,t)))}isPointInPath(t){let e=t,i=this.getControlPoints(),s=i.map(((t,e)=>[t,i[(e+1)%i.length]])).slice(0,7),h=e.x,a=e.y,o=!1;for(let t=0,e=s.length;t<e;t++){let e=s[t][0].x,i=s[t][0].y,n=s[t][1].x,r=s[t][1].y;if(e===h&&i===a||n===h&&r===a)return!0;if(i===r&&i===a&&(e>h&&n<h||e<h&&n>h))return!0;if(i<a&&r>=a||i>=a&&r<a){let t=e+(a-i)*(n-e)/(r-i);if(t===h)return!0;t>h&&(o=!o)}}return!!o}}class h extends e{constructor(t,e){super(t,e),this.type="polygon"}getControlPoints(){return this.points}initPoints(t,e){this.points.length>1?this.points.splice(this.points.length-1,1,e):this.points=[t,e]}drawGraph(){let t=this.ctx.getTransform();this.ctx.save(),this.ctx.beginPath(),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.strokeStyle=this.lineColor,this.ctx.fillStyle=this.lineColor,this.ctx.lineWidth=this.lineWidth,this.points.forEach(((e,i)=>{let{x:s,y:h}=e;s=s*t.a+t.e,h=h*t.a+t.f,0===i?this.ctx.moveTo(s,h):this.ctx.lineTo(s,h)})),this.ctx.save(),this.ctx.globalAlpha=this.opacity,this.ctx.fill(),this.ctx.restore(),this.ctx.closePath(),this.ctx.stroke(),this.ctx.restore(),this.activating&&this.drawControls()}getArea(){let t=this.points.map(((t,e)=>[t,this.points[(e+1)%this.points.length]])),e=0;for(let i=0,s=t.length;i<s;i++){let s=t[i];e+=s[0].x*s[1].y-s[0].y*s[1].x}return e=Math.abs(e/2),e}getMaxAndMinmun(){let t=[],e=[];this.points.forEach((i=>{t.push(i.x),e.push(i.y)}));let i=Math.max.apply(null,t),s=Math.min.apply(null,t);return{max:{x:i,y:Math.max.apply(null,e)},min:{x:s,y:Math.min.apply(null,e)}}}getShapeCenter(){let{max:t,min:e}=this.getMaxAndMinmun();return{x:(t.x+e.x)/2,y:(t.y+e.y)/2}}isIntersect(t){let e=this.points.slice(),i=e.map(((t,i)=>[t,e[(i+1)%e.length]])),s=i.slice(i.length-3,i.length-2),h=i.slice(-1).concat(i.slice(0,i.length-3)),a=Math.max,o=Math.min,[n,r]=t?i.slice(-1)[0]:s[0];for(let t=0;t<h.length;t++){let[e,i]=h[t];if(a(n.x,r.x)>o(e.x,i.x)&&o(n.x,r.x)<a(e.x,i.x)&&a(n.y,r.y)>o(e.y,i.y)&&o(n.y,r.y)<a(e.y,i.y)&&((e.x-n.x)*(r.y-n.y)-(e.y-n.y)*(e.x-n.x))*((i.x-n.x)*(r.y-n.y)-(i.y-n.y)*(r.x-n.x))<0&&((n.x-e.x)*(i.y-e.y)-(n.y-e.y)*(i.x-e.x))*((r.x-e.x)*(i.y-e.y)-(r.y-e.y)*(i.x-e.x))<0)return!0}return!1}updateGraph(t,e){this.points[t]=e}isPointInPath(t){let e=t,i=this.points.slice(),s=i.map(((t,e)=>[t,i[(e+1)%i.length]])),h=e.x,a=e.y,o=!1;for(let t=0,e=s.length;t<e;t++){let e=s[t][0].x,i=s[t][0].y,n=s[t][1].x,r=s[t][1].y;if(e===h&&i===a||n===h&&r===a)return!0;if(i===r&&i===a&&(e>h&&n<h||e<h&&n>h))return!0;if(i<a&&r>=a||i>=a&&r<a){let t=e+(a-i)*(n-e)/(r-i);if(t===h)return!0;t>h&&(o=!o)}}return!!o}}let a=class extends e{constructor(t,e){super(t,e),this.type="line"}getControlPoints(){return this.points}initPoints(t,e){this.points.length>1?this.points.splice(this.points.length-1,1,e):this.points=[t,e]}drawGraph(){let t=this.ctx.getTransform();this.ctx.save(),this.ctx.beginPath(),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.lineWidth=this.lineWidth||5,this.ctx.strokeStyle=this.lineColor,this.points.forEach(((e,i)=>{let{x:s,y:h}=e;s=s*t.a+t.e,h=h*t.a+t.f,0===i?this.ctx.moveTo(s,h):this.ctx.lineTo(s,h)})),this.ctx.stroke(),this.ctx.closePath(),this.ctx.restore(),this.activating&&this.drawControls()}isIntersect(t){let e=this.points.slice(),i=e.map(((t,i)=>[t,e[(i+1)%e.length]])),s=i.slice(i.length-3,i.length-2),h=i.slice(-1).concat(i.slice(0,i.length-3)),a=Math.max,o=Math.min,[n,r]=t?i.slice(-1)[0]:s[0];for(let t=0;t<h.length;t++){let[e,i]=h[t];if(a(n.x,r.x)>o(e.x,i.x)&&o(n.x,r.x)<a(e.x,i.x)&&a(n.y,r.y)>o(e.y,i.y)&&o(n.y,r.y)<a(e.y,i.y)&&((e.x-n.x)*(r.y-n.y)-(e.y-n.y)*(e.x-n.x))*((i.x-n.x)*(r.y-n.y)-(i.y-n.y)*(r.x-n.x))<0&&((n.x-e.x)*(i.y-e.y)-(n.y-e.y)*(i.x-e.x))*((r.x-e.x)*(i.y-e.y)-(r.y-e.y)*(i.x-e.x))<0)return!0}return!1}updateGraph(t,e){this.points[t]=e}isPointInPath(t){let e=this.ctx.getTransform(),i=this.points.map(((t,e)=>[t,this.points[(e+1)%this.points.length]])).slice(0,this.points.length-1);for(let s=0,h=i.length;s<h;s++){let h=i[s][0],a=i[s][1],o=Math.sqrt(Math.pow(t.x-h.x,2)+Math.pow(t.y-h.y,2));if(Math.sqrt(Math.pow(t.x-a.x,2)+Math.pow(t.y-a.y,2))+o-Math.sqrt(Math.pow(a.x-h.x,2)+Math.pow(a.y-h.y,2))<.02/e.a)return this}}};class o extends e{constructor(t,e){super(t,e),this.type="line"}getControlPoints(){return this.points}initPoints(t,e){this.points.length>1?this.points.splice(this.points.length-1,1,e):this.points=[t,e]}drawGraph(){let t=this.ctx.getTransform(),e=this.ctx;e.save(),e.beginPath(),e.setTransform(1,0,0,1,0,0),e.strokeStyle=this.lineColor;let[i,s,h]=this.points,{x:a,y:o}=i,{x:n,y:r}=s;if(a=a*t.a+t.e,o=o*t.a+t.f,n=n*t.a+t.e,r=r*t.a+t.f,e.rect(a,o,n-a,r-o),e.stroke(),e.closePath(),h){e.beginPath();let{x:i,y:s}=h;i=i*t.a+t.e,s=s*t.a+t.f,e.rect(a+i-n,o+s-r,n-a,r-o),e.stroke(),e.closePath(),e.beginPath(),e.moveTo(a,o),e.lineTo(a+i-n,o+s-r),e.moveTo(n,o),e.lineTo(n+i-n,o+s-r),e.moveTo(a,r),e.lineTo(a+i-n,s),e.moveTo(n,r),e.lineTo(n+i-n,s),e.stroke(),e.closePath()}this.ctx.restore(),this.editing&&this.drawControls()}drawControls(){let t=this.ctx.getTransform();this.ctx.save(),this.ctx.setTransform(1,0,0,1,0,0),this.getControlPoints().forEach((e=>{this.ctx.beginPath(),this.ctx.fillStyle=this.fillColor,this.ctx.arc(e.x*t.a+t.e,e.y*t.a+t.f,5,0,2*Math.PI),this.ctx.fill(),this.ctx.closePath()})),this.ctx.restore()}isPointInPath(t){let e=document.createElement("canvas").getContext("2d");e.setTransform(this.ctx.getTransform());let i=e.getTransform();console.log(i,t.x,t.y),e.save(),e.beginPath(),e.setTransform(1,0,0,1,0,0),e.strokeStyle=this.lineColor;let[s,h,a]=this.points,{x:o,y:n}=s,{x:r,y:l}=h;if(o=o*i.a+i.e,n=n*i.a+i.f,r=r*i.a+i.e,l=l*i.a+i.f,e.rect(o,n,r-o,l-n),e.stroke(),e.closePath(),a){e.beginPath();let{x:t,y:s}=a;t=t*i.a+i.e,s=s*i.a+i.f,e.rect(o+t-r,n+s-l,r-o,l-n),e.stroke(),e.closePath(),e.beginPath(),e.moveTo(o,n),e.lineTo(o+t-r,n+s-l),e.moveTo(r,n),e.lineTo(r+t-r,n+s-l),e.moveTo(o,l),e.lineTo(o+t-r,s),e.moveTo(r,l),e.lineTo(r+t-r,s),e.stroke(),e.closePath()}e.restore(),e.isPointInPath(t.x,t.y)&&console.log(1231231)}}class n extends e{constructor(t,e){super(t,e),this.type="point"}getControlPoints(){return this.points}initPoints(t){this.points.push(t)}drawGraph(){let t=this.ctx.getTransform(),e=this.ctx;e.save(),e.setTransform(1,0,0,1,0,0),e.beginPath(),e.arc(this.points[0].x*t.a+t.e,this.points[0].y*t.a+t.f,5,0,2*Math.PI),e.fillStyle=this.lineColor,e.fill(),e.closePath(),e.restore(),this.activating&&this.drawControls()}drawControls(){let t=this.ctx.getTransform(),e=this.ctx;e.save(),e.setTransform(1,0,0,1,0,0),e.beginPath(),e.arc(this.points[0].x*t.a+t.e,this.points[0].y*t.a+t.f,10,0,2*Math.PI),e.strokeStyle=this.lineColor,e.stroke(),e.closePath(),e.restore()}isPointInPath(t){let{x:e,y:i}=this.points[0];return e-5<t.x&&t.x<e+5&&t.y<i+5&&t.y>i-5}}let r=0;function l(t,e){r||(t(),r=Date.now()),Date.now()-r<e||(t(),r=Date.now())}return class extends t{rightMouseDown=!1;rightMouseMove=!1;dbclickTime=0;canvasDOM=null;offsetX=0;offsetY=0;img=new Image;activeShape=null;constructor({el:t,width:e,height:r,imgUrl:l,minScale:c,maxScale:x,focusMode:p,selectTool:u,font:d,customTag:y}){super(),this.el=t,this.shapeList=[],this.width=e||window.innerWidth,this.height=r||window.innerHeight,this.selectTool=u||"select",this.img.src=l,this.scale=1,this.minScale=c||.6,this.maxScale=x||40,this.index=0,this.activeIndex=-1,this.pixelSize={},this.matrix=i,this.focusMode=p||!1,this.font=d||"14px 微软雅黑",this.customTag=y||!1,this.mouse={down:!1,move:!1,up:!1,mousedownPos:{x:0,y:0},mousemovePos:{x:0,y:0},mouseupPos:{x:0,y:0},mousewheelPos:{x:0,y:0}},this.img.setAttribute("crossOrigin","anonymous"),this.img.onload=()=>{this.pixelRatio=this.img.naturalWidth/this.img.naturalHeight,this.pixelSize={w:this.img.naturalWidth,h:this.img.naturalHeight},this.imgHeight=this.width/this.pixelRatio,this.init()},this.Rect=s,this.Polygon=h,this.Line=a,this.Point=n,this.Cube=o}init(){if(!this.el)return t="You should provide an 'el' attribute and it needs to be set to 'string | HTMLCanvasElement'",void(e?console.error(t,e):console.error(t));var t,e;this.el instanceof HTMLCanvasElement?this.canvasDOM=this.el:"string"==typeof this.el&&(this.canvasDOM=document.querySelector(this.el)),this.ctx=this.canvasDOM.getContext("2d"),this.ctx.font="10px 微软雅黑",this.canvasDOM.width=this.width,this.canvasDOM.height=this.height,this.canvasDOM.addEventListener("mousedown",this.handleMouseDown.bind(this)),this.canvasDOM.addEventListener("mousemove",(t=>{l(this.handleMouseMove.bind(this,t),10)})),this.canvasDOM.addEventListener("mouseup",this.handleMouseUp.bind(this)),this.canvasDOM.addEventListener("mousewheel",this.handleMouseWheel.bind(this)),document.addEventListener("contextmenu",(t=>{t.preventDefault()})),this.update(),this.emit("created")}setImage(t){this.img.src=t,this.img.setAttribute("crossOrigin","anonymous"),this.img.onload=()=>{this.pixelRatio=this.img.naturalWidth/this.img.naturalHeight,this.pixelSize={w:this.img.naturalWidth,h:this.img.naturalHeight},this.imgHeight=this.width/this.pixelRatio,this.update()}}fitInWindow(){i.reset(),i.scaleU(.65);let t=(this.width-.65*this.width)/2,e=(this.height-.65*this.imgHeight)/2;i.translate(t,e),this.ctx.setTransform(i.clone()),this.update()}resetCanvas(){i.reset(),this.ctx.setTransform(i.clone()),this.update()}addShape(t){this.shapeList.push(t)}update(){this.clear(),this.ctx.drawImage(this.img,0,0,this.width,this.imgHeight),this.shapeList.forEach(((t,e)=>{t.index=e,t.drawGraph(),!this.customTag&&t.drawText(),this.customTag&&this.customTag(t,e)}))}clear(){this.ctx.save(),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.clearRect(0,0,this.width,this.height),this.ctx.restore()}getActiveShapeIndex(){if(~this.activeIndex)return this.activeIndex;if(!this.activeShape)return t="You need to select a graphic, but the program did not obtain it. Please confirm",void console.warn(t);var t;return this.shapeList.findIndex((t=>t.uuid===this.activeShape.uuid))}getCurrentActiveShape(){let t=this.shapeList.filter((t=>t.activating));return t.length?t[0]:null}mouseEventPosition(t){let e=this.canvasDOM.getBoundingClientRect(),s={x:(t.clientX-e.x-i.e)/i.a,y:(t.clientY-e.y-i.f)/i.a};return s.x=s.x<0?0:s.x>this.width?this.width:s.x,s.y=s.y<0?0:s.y>this.imgHeight?this.imgHeight:s.y,s}handleMouseWheel(t){let{x:e,y:s}=this.mousewheelPos=this.mouseEventPosition(t),h=1+.2*(t.deltaY<0?1:-1);i.translate(e,s).scaleU(h),i.a<.3&&i.scaleU(.3/i.a),i.a>40&&i.scaleU(40/i.a),i.translate(-e,-s),this.ctx.setTransform(i.clone()),this.update()}handleMouseDown(t){if(t.preventDefault(),this.dbclickTime&&Date.now()-this.dbclickTime<300){if(this.activeShape&&this.activeShape.intersect)return;if(this.activeShape&&["polygon","line"].includes(this.activeShape.type)){if(this.activeShape.points.length>4&&"polygon"===this.activeShape.type&&this.activeShape.isIntersect("drawOver")&&JSON.stringify(this.mouseEventPosition(t))===JSON.stringify(this.mouse.mousedownPos))return void this.activeShape.points.splice(this.activeShape.points.length-1,1);if(JSON.stringify(this.mouseEventPosition(t))===JSON.stringify(this.mouse.mousedownPos))return this.activeShape.points.splice(this.activeShape.points.length-1,1),this.activeShape.creating=!1,this.activeShape.activating=!0,void this.update()}}else this.dbclickTime=Date.now();if(this.mouse.mousedownPos=this.mouseEventPosition(t),2===t.button)return this.rightMouseDown=!0,void this.setMouseCursor("grab");if(this.activeShape&&(this.mouse.down=!0),this.activeShape&&~this.activeShape.editIndex)"point"!==this.activeShape.type&&(this.activeShape.editing=!0);else{if("select"===this.selectTool)return this.activeShape&&(this.activeShape.activating=!1,this.activeShape=null),~this.activeIndex?(this.activeShape=this.shapeList[this.activeIndex],this.activeShape.activating=!0,this.focusMode&&this.setFocusMode(),this.emit("selectedShape",this.activeShape),void this.update()):void this.update();if(this.activeShape?.creating){switch(this.selectTool){case"rect":this.activeShape.creating=!1,this.activeShape.activating=!0;break;case"line":case"polygon":this.activeShape.points.splice(this.activeShape.points.length-1,1,this.mouse.mousedownPos,this.mouse.mousedownPos),this.activeShape.intersect=!1,this.activeShape.points.length>4&&this.activeShape.isIntersect()&&(this.activeShape.points.splice(this.activeShape.points.length-1,1),this.activeShape.intersect=!0);break;case"cube":if(3===this.activeShape.points.length){this.activeShape.creating=!1;break}this.activeShape.points.splice(this.activeShape.points.length-1,1,this.mouse.mousedownPos,this.mouse.mousedownPos)}this.update()}else if(this.selectTool){if(this.activeShape&&(this.activeShape.activating=!1),this.activeShape=this.createShape(this.selectTool,this.shapeProps||{}),"point"===this.selectTool)return this.activeShape.initPoints(this.mouse.mousedownPos),this.activeShape.activating=!0,this.addShape(this.activeShape),void this.update();this.activeShape.creating=!0,this.addShape(this.activeShape)}}}handleMouseMove(t){if(this.mouse.mousemovePos=this.mouseEventPosition(t),this.rightMouseDown){this.setMouseCursor("grabbing");let t=this.mouse.mousemovePos.x-this.mouse.mousedownPos.x,e=this.mouse.mousemovePos.y-this.mouse.mousedownPos.y;return i.translate(t,e),this.ctx.setTransform(i.clone()),void this.update()}if(this.activeShape&&this.activeShape.editing)return this.activeShape.updateGraph(this.activeShape.editIndex,this.mouse.mousemovePos,this.mouse.mousedownPos),void this.update();if(this.activeShape&&this.activeShape.canDrag&&this.mouse.down&&this.activeShape.activating)return this.dragShape(this.mouse.mousedownPos,this.mouse.mousemovePos),this.mouse.mousedownPos=this.mouse.mousemovePos,void this.update();if(this.activeShape&&this.activeShape.activating&&(this.activeShape.editIndex=this.activeShape.controlPointsIndex(this.mouse.mousemovePos)),"select"!==this.selectTool){if(this.activeShape?.creating){switch(this.selectTool){case"rect":case"line":case"polygon":case"cube":this.activeShape.initPoints(this.mouse.mousedownPos,this.mouse.mousemovePos)}this.update()}}else this.selectShape()}selectShape(){this.setMouseCursor("auto");let t=this.shapeList.filter((t=>(this.activeShape&&t.uuid===this.activeShape.uuid||(t.activating=!1,t.editing=!1),t.isPointInPath(this.mouse.mousemovePos))));t.length||(this.activeIndex=-1);let e=0;if(1===t.length){let e=t[0];this.activeIndex=e.index,this.emit("hoverShape",e)}else for(let i=0;i<t.length;i++){let s=t[i];if("line"===s.type)return this.activeIndex=s.index,this.update(),void this.emit("hoverShape",s);let h=s.getArea();if(e){if(h<e)return this.activeIndex=s.index,this.update(),void this.emit("hoverShape",s)}else e=h,this.activeIndex=s.index,this.update(),this.emit("hoverShape",s)}this.update()}handleMouseUp(){this.rightMouseDown&&(this.setMouseCursor("auto"),this.rightMouseDown=!1),this.activeShape&&this.activeShape.editing&&(this.activeShape.editing=!1),this.mouse.down&&(this.mouse.down=!1)}setFocusMode(){let{x:t,y:e}=this.activeShape.getShapeCenter(),{max:s,min:h}=this.activeShape.getMaxAndMinmun(),{w:a,h:o}={w:this.width,h:this.height},n=Math.floor(o/(s.y-h.y))-.3;i.reset(),i.scaleU(n),i.e+=a/2-t*i.a,i.f+=o/2-e*i.a,this.ctx.setTransform(i.clone()),this.update()}createShape(t,e){let i=null;return i=new(0,this[t.slice(0,1).toUpperCase()+t.slice(1)])(this.ctx,e),i}dragShape(t,e){let i,s,h,a,o=e.x-t.x,n=e.y-t.y,r=this.activeShape.points;if(o>=0&&(i=Math.max.apply(null,r.map((t=>t.x)))),n>=0&&(s=Math.max.apply(null,r.map((t=>t.y)))),o<=0&&(h=Math.min(...r.map((t=>t.x)))),n<=0&&(a=Math.min(...r.map((t=>t.y)))),!(i+o>=this.width||s+n>=this.imgHeight||h+o<=0||a+n<=0))for(let t=0;t<r.length;t++){let e=r[t];e.x=e.x+o,e.y=e.y+n}}setMouseCursor(t){this.canvasDOM.style.cursor=t}setData(t){this.shapeList=[];let e=null;t.forEach((t=>{t.points.forEach((t=>{t.x=t.x/this.img.naturalWidth*this.width,t.y=t.y/this.img.naturalHeight*this.imgHeight})),e=this.createShape(t.type,t),this.shapeList.push(e)})),this.update()}deleteByIndex(t){this.shapeList.splice(t,1)}getResultData(){let t=this.shapeList.map((t=>t.getData()));return{pixelSize:this.pixelSize,regions:t}}destory(){this.canvasDOM.removeEventListener("mousedown",this.handleMouseDown.bind(this)),this.canvasDOM.removeEventListener("mousemove",(t=>{l(this.handleMouseMove.bind(this,t),10)})),this.canvasDOM.removeEventListener("mouseup",this.handleMouseUp.bind(this)),this.canvasDOM.removeEventListener("mousewheel",this.handleMouseWheel.bind(this)),document.removeEventListener("keydown",(t=>{"r"===t.key&&(i.reset(),this.ctx.setTransform(i.clone()),this.update()),"v"===t.key&&(this.selectTool="select")})),document.removeEventListener("contextmenu",(t=>{t.preventDefault()}))}}}));
